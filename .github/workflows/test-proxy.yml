# .github/workflows/proxy-test.yml
name: 🔍 Proxy Tester - Guaranteed Working Version

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:       # Manual trigger
  push:
    branches: [ main, master ]
    paths: 
      - 'proxy-tester.js'
      - '.github/workflows/proxy-test.yml'

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write      # CRITICAL: Need this for pushing
      actions: read
      
    steps:
    - name: 🔄 Checkout Repository  
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
    
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: 📦 Install Dependencies
      run: |
        npm install axios https-proxy-agent --save
        echo "Dependencies installed successfully"
        
    - name: 🧪 Run Proxy Tester
      timeout-minutes: 90
      run: |
        echo "Starting proxy testing at $(date)"
        node proxy-tester.js
        echo "Proxy testing completed at $(date)"
        
    - name: 📊 Verify Results
      run: |
        echo "=== File verification ==="
        ls -la *.txt *.log *.json 2>/dev/null || echo "No result files found"
        
        if [ -f "hasil.txt" ]; then
          echo "✅ hasil.txt found with $(wc -l < hasil.txt) lines"
          echo "Preview:"
          head -5 hasil.txt
        else
          echo "❌ hasil.txt not found!"
        fi
        
    - name: 📤 Commit and Push Results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: |
          🤖 Auto-update proxy results - ${{ github.run_number }}
          
          - Generated at: ${{ steps.date.outputs.date }}
          - Run ID: ${{ github.run_id }}
          - Working proxies updated
        file_pattern: '*.txt *.log *.json'
        commit_user_name: GitHub Actions
        commit_user_email: actions@github.com
        commit_author: GitHub Actions <actions@github.com>
        
    - name: 📋 Summary
      if: always()
      run: |
        echo "=== EXECUTION SUMMARY ==="
        echo "Run ID: ${{ github.run_id }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        
        if [ -f "hasil.txt" ]; then
          WORKING_COUNT=$(grep -c '^[0-9]' hasil.txt 2>/dev/null || echo '0')
          echo "Working proxies found: ${WORKING_COUNT}"
        fi
        
        echo "Files generated:"
        ls -la *.txt *.log *.json 2>/dev/null || echo "None"
